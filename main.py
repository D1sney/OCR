import fitz  # PyMuPDF
from PIL import Image, ImageEnhance, ImageOps
import pytesseract
import cv2
import numpy as np
import re

# Если Tesseract не находится в PATH, укажите путь к исполняемому файлу:
# pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'

def preprocess_image(image):
    # Преобразуем изображение в оттенки серого
    gray = cv2.cvtColor(np.array(image), cv2.COLOR_RGB2GRAY)
    # Применяем пороговое преобразование для улучшения качества OCR
    _, thresh = cv2.threshold(gray, 150, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)
    return Image.fromarray(thresh)

def correct_rotation(image):
    # Преобразуем изображение в оттенки серого
    gray = cv2.cvtColor(np.array(image), cv2.COLOR_RGB2GRAY)
    # Используем детектор границ Canny
    edges = cv2.Canny(gray, 50, 150, apertureSize=3)
    # Находим линии с помощью преобразования Хафа
    lines = cv2.HoughLinesP(edges, 1, np.pi / 180, threshold=100, minLineLength=100, maxLineGap=10)
    if lines is not None:
        angles = []
        for line in lines:
            x1, y1, x2, y2 = line[0]
            angle = np.arctan2(y2 - y1, x2 - x1) * 180 / np.pi
            angles.append(angle)
        # Находим медианный угол и корректируем поворот
        median_angle = np.median(angles)
        if abs(median_angle) > 45:
            median_angle -= 90
        return image.rotate(-median_angle, expand=True)
    else:
        return image

# Открываем PDF документ
pdf_path = 'Заявление 3.4 Трудовая 34.pdf'
pdf_document = fitz.open(pdf_path)

# Обрабатываем первую страницу, пропуская верхнюю 1/6 часть
page_num = 0
page = pdf_document.load_page(page_num)

# Определяем размеры страницы и область (clip), исключающую верхнюю 1/6
rect = page.rect
clip_rect = fitz.Rect(rect.x0, rect.y0 + (rect.height / 5), rect.x1, rect.y1)

# Рендерим область страницы с увеличенным разрешением для повышения качества OCR
pix = page.get_pixmap(matrix=fitz.Matrix(3, 3), clip=clip_rect)
img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)

# Корректируем поворот изображения (если необходимо)
corrected_img = correct_rotation(img)
# Применяем предобработку (оттенки серого + пороговое преобразование)
preprocessed_img = preprocess_image(corrected_img)

# Выполняем OCR с указанием русского языка
ocr_text = pytesseract.image_to_string(preprocessed_img, lang='rus')

# Нормализуем текст: убираем переносы строк и лишние пробелы
normalized_text = re.sub(r'\s+', ' ', ocr_text)

# Выводим нормализованный текст
print("Нормализованный текст OCR:")
print(normalized_text)

# Сохраняем текст в файл (при необходимости)
with open('extracted_text.txt', 'w', encoding='utf-8') as f:
    f.write(normalized_text)
# ===== Извлечение системы по списку =====

systems = [
    "Утепление фасада с применением навесного фасада",
    "Утепление фасада с применением системы с тонким наружным штукатурным слоем",
    "Утепление фасада с применением СУФ «Термолэнд»",
    "Ремонт (замена) козырьков подъездов",
    "Ремонт несущих конструкций с усилением конструктивных элементов",
    "Ремонт мягкой рулонной кровли, с утеплением, для многоквартирных домов, не имеющих чердачного помещения",
    "Замена балконных плит",
    "Ремонт металлической кровли",
    "Замена кровли из АЦЛ на оцинкованный профлист",
    "Ремонт чердачного помещения",
    "Замена стропильной системы",
    "Ремонт кровли из металлочерепицы",
    "Ремонт кровли из профнастила",
    "Ремонт чердачного помещения по периметру с утеплением",
    "Ремонт чердачного помещения с утеплителем СМЛ (стекломагниевые листы)",
    "Ремонт чердачного помещения с применением плит из минеральной ваты",
    "Ремонт чердачного помещения с керамзитом",
    "Переустройство невентилируемой крыши на вентилируемую крышу",
    "Замена стояков центрального отопления с радиаторами по новым отверстиям (если существующая система находится в стенах)",
    "Замена стояков центрального отопления без радиаторов по новым отверстиям (если существующая система находится в стенах)",
    "Замена стояков холодного водоснабжения по новым отверстиям (если существующая система находится в стене)",
    "Замена стояков горячего водоснабжения по новым отверстиям (если существующая система находится в стене)",
    "Замена системы канализации по новым отверстиям (если существующая система находится в стене)",
    "Замена системы внутреннего газопровода (без газовых плит)",
    "Ремонт или замена фасадного газопровода при утеплении фасада",
    "Ремонт или замена внутридомовой газовой разводки (без стоимости оборудования)",
    "Вынос газопровода из подъездов (без реконструкции внутридомового газопровода)",
    "Обрезка в земле подземного газопровода 1 место (протяженность подземного газопровода до места присоединения не выше 15 пог.м.)",
    "Ремонт внутреннего газопровода (без газовых плит) и внутридомовой газовой разводки (без стоимости оборудования) с установкой датчиков загазованности с клапанами",
    "Установка датчиков загазованности с клапанами при проведениикапитального ремонта системы газоснабжения",
    "Замена вводно-распределительного устройства",
    "Замена магистралей (стояки)",
    "Замена общедомовой системы освещения",
    "Замена этажного распределительного щита",
    "Замена вводно-распределительного устройства",
    "Замена магистралей (стояки)",
    "Замена общедомовой системы освещения",
    "Замена этажного распределительного щита",
    "Ремонт внутреннего противопожарного водопровода с заменой элементов и стройств системы",
    "Ремонт (замена) крышных котельных, относящихся к составу общего имущества",
    "Ремонт фундамента многоквартирного дома",
    "Замена лифта без направляющих, грузоподъёмностью 400 кг с количеством остановок 9",
    "Замена лифта без направляющих, грузоподъёмностью 630 кг с количеством остановок 9",
    "Ремонт лифтовой шахты",
    "Замена металлических ограждающих конструкций лифтовой шахты споследующей обшивкой тонколистовой сталью",
    "Ремонт или замена отдельного лифтового оборудования, в том числе направляющих",
    "Ремонт машинного помещения",
    "Замена лифта без направляющих грузоподъемностью 1000 кг с количеством остановок 20 без машинного помещения",
    "Замена лифта без направляющих грузоподъемностью 1000 кг с количеством остановок 20 с машинным помещением",
    "Замена лифта без направляющих грузоподъемностью 1275кг с количеством остановок 20 без машинного помещения",
    "Замена лифта без направляющих грузоподъемностью 1275кг с количеством остановок 20 с машинным помещением",
    "Установка узла управления тепловой энергии, в том числе заводской готовности, мощностью от 80 до 200 Мкал/час",
    "Установка узла управления тепловой энергии, в том числе заводской готовности, мощностью от 201 до 500 Мкал/час",
    "Установка узла управления системы горячего водоснабжения по двухступенчатой схеме подключения, в том числе заводской готовности, мощностью от 100 до 200 Мкал/час",
    "Установка узла управления системы горячего водоснабжения по двухступенчатой схеме подключения, в том числе заводской готовности, мощностью от 201 до 400 Мкал/час",
    "Установка коллективного (общедомового) узла учёта тепловой энергии и теплоносителя в системах центрального отопления, горячего водоснабжения, холодного водоснабжения",
    "Установка автоматизированного узла управления с секционными узлами, узла тепловой энергии, горячего водоснабжения, холодного водоснабжения",
    "Замена и (или) восстановление инженерных сетей многоквартирного дома",
    "Ремонт деревянного или смешанного фасада",
    "Ремонт кирпичного неоштукатуренного фасада",
    "Ремонт фасада панельного/блочного неоштукатуренного (без ремонта межпанельных швов)",
    "Ремонт фасада, облицованного плиткой",
    "Ремонт межпанельных швов",
    "Ремонт межпанельных швов (с применением канатного метода)",
    "Ремонт межпанельных швов с люльки",
    "Ремонт оштукатуренного фасада",
    "Ремонт панельного фасада, окрашенного (облицованного) с межпанельными швами",
    "Ремонт панельного фасада с устройством декоративно-защитного слоя и ремонтом межпанельных швов",
    "Замена системы наружного водостока",
    "Ремонт балконных плит",
    "Замена оконных и балконных блоков в местах общего пользования",
    "Замена входных дверей в подъезды, мусорокамеры на металлические двери в энергосберегающем исполнении",
    "Замена входных дверей в подъезды, наметаллические двери в энергосберегающем исполнении, с установкой IP-видеодомофонов без подключения",
    "Установка и разборка строительных лесов с защитной сеткой",
    "Ремонт мягкой рулонной кровли, без утепления, для многоквартирных домов, не имеющих чердачного помещения",
    "Ремонт мягкой безрулонной кровли",
    "Ремонт кровли из асбестоцементных листов",
    "Замена системы внутреннего водостока",
    "Ремонт мастичной кровли",
    "Ремонт резиновой кровли",
    "Ремонт внутридомовых инженерных систем",
    "Замена стояков центрального отопленияс радиаторами",
    "Замена стояков центрального отопления без отопительных приборов",
    "Замена стояков центрального отопления (подвал, чердак) с их теплоизоляцией и запорной арматурой",
    "Замена стояков центрального отопления в домах с подключенными к системе полотенцесушителями",
    "Вскрытие и восстановление полов квартир первых этажей при замене системы центрального отопления, холодного водоснабжения, горячего водоснабжения",
    "Замена стояков в квартирах с изоляцией и запорной арматурой",
    "Замена разводящих трубопроводов в подвале (чердаке) с изоляцией и запорной арматурой",
    "Замена стояков в квартирах с изоляцией и запорной арматурой",
    "Замена разводящих трубопроводов в подвале (чердаке) с изоляцией и запорной арматурой",
    "Замена системы канализации (стояки)",
    "Замена системы канализации (подвал)",
    "Вскрытие и восстановление полов квартир первых этажей при замене системы канализации",
    "Ремонт подвального помещения, относящегося к общему имуществу многоквартирного дома",
    "Ремонт подвального помещения, относящегося к общему имуществу многоквартирного дома методом гидроизоляции стен и полов",
    "Ремонт отмостки",
    "Ремонт скатной крыши",
    "Демонтаж ствола мусоропровода в МКД",
    "Hемонт системы горячего водоснабжения с установкой коллективных (общедомовых) приборов учета потребления ресурсов",
    "Обустройство колясочной в МКД",
    "Ремонт системы холодного водоснабжения с установкой коллективных (общедомовых) приборов учета потребления ресурсов"
]

# Поиск системы в нормализованном тексте
system_description = None
for system in systems:
    # Также нормализуем вариант системы из списка
    normalized_system = re.sub(r'\s+', ' ', system)
    if normalized_system in normalized_text:
        system_description = normalized_system
        break

if system_description is None:
    system_description = "System description not found"

print(f"System: {system_description}")

# ===== Извлечение адреса =====
address_pattern = (
    r'(?:(?:[А-ЯЁа-яё]+\s+область),\s*)?'                      # Опционально: "Московская область, "
    r'(?:'                                                    # Группа для последовательности сегментов
         r'(?:г|д|тер|ул|пл|мкр|с|п|пр-кт|проезд)\.?\s*'       # Допустимые префиксы (точка опциональна)
         r'[А-ЯЁа-яё\w\-\s]+'                                  # Название сегмента (буквы, цифры, дефисы, пробелы)
         r'(?:[0-9]+[а-яА-Яa-zA-Z0-9\/\-]*)?'                  # Опциональный числовой суффикс (например, "Можайск-3")
         r'\s*,\s*'                                           # Разделитель – запятая с пробелами
    r')+'
    r'д\.?\s*\d+[а-яА-Яa-zA-Z0-9\/\-]*'                        # Финальный сегмент: "д. 7" или "д. 7а"
)

address_match = re.search(address_pattern, normalized_text)
if address_match:
    address = address_match.group()
else:
    address = "Address not found"

print(f"Address: {address}")

# Сохраняем извлечённую информацию в файл
with open('extracted_info.txt', 'w', encoding='utf-8') as f:
    f.write(f"System: {system_description}\n")
    f.write(f"Address: {address}\n")